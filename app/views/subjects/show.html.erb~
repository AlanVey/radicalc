<div class="page-main">

<% if @subject.readable_by?(current_user) %>

<p>
  <strong>Name:</strong>
  <%= @subject.name %>
</p>

<p>
  <%= "This is a #{@subject.debate_type} node" %>
</p>

<p>
  <strong>Body:</strong>
  <%= @subject.body %>
</p>

<p>
  <strong>User:</strong>
  <%= @subject.user.email %>
</p>

<% if @subject.parent != nil %>

  <section class="header">
    <h2>
      <% @subject.get_ancestors.each do |s| %> 
        <% if s == @subject.get_ancestors.first %>
           <% if s == @subject.get_ancestors.last %>
             <%= s.name %>
           <% else %>
             <%= s.name %> <p> << </p>
           <% end %>
        <% else %>
           <% if s == @subject.get_ancestors.last %>
             <p><%= link_to s.name, show_subject_path(s) %> </p>
           <% else %>
             <p><%= link_to s.name, show_subject_path(s) %> << </p>
           <% end %>
         <% end %>
      <% end %>
    </h2>
  </section>

  <section class="profile-section">
    <div class="container profile-block">
      <div class="row">
        <div class="col-xs-6" id="profile-block-left">
          <%= image_tag('topic.png', class: 'img-circle', id: 'profilepic') %>
          <br/>
          <%= link_to 'Edit Topic', edit_subject_path(@subject), :class => "btn btn-primary" %>
        </div>

        <div class="col-xs-6">
          <p>
            <strong>Topic Name:</strong>
            <%= @subject.name %>
          </p>

          <p>
            <strong>Admin:</strong>
            <%= @subject.user.email %>
          </p>   
       
          <p>
            <strong>Description:</strong>
            <%= @subject.body %>
          </p>
        </div>
      </div>
    </div>
  </section>

  <br/>
 

   <section>
    <h2>Discussions and Tests</h2>

    <p class="mini-p">
    <%= link_to 'General Discussion', questions_path(kind: 'General'), :class => "btn btn-default" %> 
    General questions about the course 
    </p>
     <br/>
     
    <p class="mini-p">
    <%= link_to 'Technical Discussion', questions_path(kind: 'Technical'), :class => "btn btn-default" %>
    Questions relating to technical content of the course
    </p>
    <br/>

     <p class="mini-p">
     <%= link_to 'Tests', tests_path, :class => "btn btn-default" %>
    Assessed tests set by the course admin
    </p>
    <br/>


   </section>

   <section>
        <h2>Subtopics</h2>
    <% if @subject.children.count > 0 %>
        <ul class="list-group subtopics">
        <% @subject.children.each do |child| %>
            <%= link_to child.name, show_subject_path(child.id), :class=> "list-group-item" %>
        <% end %>
        </ul>
        <% else %>
        <p>This topic has no subtopics</p>
    <% end %>
   </section>

  <p>
    <%= link_to '<strong>+</strong>Add Subtopic'.html_safe, new_subject_path(@subject.id), :class=>"btn btn-primary" %><br>
   
<!-- <%= link_to 'Questions', questions_path(kind: 'General') %> -->
  </p>

<% end %>

  <section>
    <h2>Subscribed Users</h2>
    <% if @subscribed_users.count > 0 %>
      <ul class="list-group subtopics">
      <% @subscribed_users.each do |user| %>
          <%= link_to user.email, show_profile_path(user.id) %> 
          <% if user == current_user or @subject.user == current_user %>
            <%= link_to 'Unsubscribe?', unsubscribe_path(subject_id:@subject.id, id:current_user.id), method: :delete %>
          <% end %>
      <% end %>
      </ul>
    <% else %>
      <p>This topic has no subscribed users</p>
    <% end %>

  </section>
  <% if @subject.updatable_by?(current_user) %>
      <p>
        <%= link_to '<strong>+</strong>Add Students'.html_safe, new_subscription_path(subject_id:@subject.id), :class=>"btn btn-primary" %><br>
      </p>
  <% end %>


<% if @subject.children.count > 0 %>
<p>
  <strong>Children:</strong>
  <% @subject.children.each do|child| %>
      <p>
        <%= link_to child.name, show_subject_path(child.id) %>
      </p>
  <% end %>
</p>
<% end %>

<p>
  <% if @subject.updatable_by?(current_user) %>
      <%= link_to 'New Subject', new_subject_path(@subject.id) %><br>
  <% end %>
<%= link_to 'Questions', questions_path(kind: 'General') %>
</p>

<%= link_to 'Edit', edit_subject_path(@subject) %> |

    <p class="mini-p">
      <%= link_to 'Back', dashboard_path, :class => "btn btn-default" %>
    </p>

	<section>
		<h2>Proficiency</h2>
    <div id="proficiency_chart" style="min-width: 310px; max-width: 400px; height: 400px; margin: 0 auto"></div>
		
	</section>

</div>

<%= render 'layouts/sidemenu' %>

		<script type="text/javascript">
			$(function () {

					$('#proficiency_chart').highcharts({

							chart: {
							    polar: true,
							    events: {
							    load: applyGraphGradient
							    }
							},

							title: {
							    text: '<%= @subject.name %>'
							},

							pane: {
							    startAngle: 0,
							    endAngle: 360
							},

							xAxis: {
							    type: 'category',
  								categories:
									<% if @subject.children.count == 0 %>
											['<%= @subject.name %>']
                  <% else %>									
									<%= raw @subject.children_names.to_json %>
                  <% end %>
							},

							yAxis: {
							    min: 0
							},

							plotOptions: {
							    column: {
							        pointPadding: 0,
							        groupPadding: 0
							    }
							    
							},

							series: [{
							    showInLegend: false,
							    type: 'column',
							    name: 'Proficiency',
							    color: 'white',
							    data: [ 
									<% if @subject.children.count == 0 %>
                     {y : 50, url : "#" }
                  <% else %>
                  <% @subject.children.each do |child| %>
									{ y : 50,
                    url : <%= raw show_subject_path(child.id).to_json %>
                  }
										<% if child != @subject.children.last %>
											,
										<% end %>
                  <% end %>
                  <% end %>
									],
							    pointPlacement: 'on',
							    cursor: 'pointer',
							    point: {
							        events: {
							            click: function () {
															location.href = this.options.url;
							            }
							        }
							    }
							}]
					});
			});

		</script>

<% else %>

<p>
  <strong>You do not have permission to see this page.</strong>
</p>

<% end %>
